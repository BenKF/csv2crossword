<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <title>CSV 2 Crossword</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        display: flex;
        flex-direction: column;
      }
      table {
        border-collapse: collapse;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(0px, 1fr));
      }

      .cell {
        aspect-ratio: 1/ 1;
        height: 100%;
        border: 1px solid #000;
        text-align: center;
        font-size: 20px;
        position: relative;
        cursor: pointer;
        background: black;
        padding: 0;
      }
      .cell.editable {
        background: white;
      }
      .cell input {
        width: 100%;
        height: 100%;
        text-align: center;
        border: none;
        outline: none;
        padding: 0;
        background: transparent;
        font-size: 20px;
        text-transform: uppercase;
        vertical-align: text-top;
      }
      .cell.highlight,
      li.highlight {
        background-color: #e0f7fa;
      }
      .cell.focus {
        background-color: #b8e8ee;
      }
      .cluenum {
        position: absolute;
        top: 0;
        left: 2px;
        font-size: 10px;
        color: black;
        pointer-events: none;
      }
      .cell.filled input {
        background: #c8e6c9;
        pointer-events: none;
      }
      .cell.revealed input {
        background: #fffed3;
        pointer-events: none;
      }
      .cell.active {
        outline: 2px solid lightskyblue;
        z-index: 1;
      }
      #clues {
        max-width: 300px;
      }
      ul {
        padding: 0;
        margin-top: 0;
      }
      li {
        list-style-type: none;
        &.strike {
          text-decoration: line-through;
          color: gray;
        }
      }
      h3 {
        margin-bottom: 5px;
      }
      button {
        margin-top: 10px;
        border-radius: 25px;
        border: 2px solid grey;
        &.reveal-letter {
          margin: 0;
        }
      }
      li:not(.highlight) .reveal-letter,
      li.strike .reveal-letter {
        display: none;
      }
      .hidden {
        display: none;
      }
      #crossword-container {
        border: 30px solid black;
        background: black;
      }
      #csv-inputs {
        border: 1px solid black;
        padding: 10px;
        margin-top: 10px;
      }
      .example {
        margin-top: 0;
        font-size: small;
        font-style: italic;
        user-select: text;
      }
      .body {
        display: flex;
        gap: 40px;
        user-select: none;
        & > div {
          width: 100%;
          max-width: 50vw;
        }
      }
      .footer {
        font-size: small;
        margin-top: 20px;
      }
      img {
        width: 100%;
      }

      @media only screen and (max-width: 768px) {
        li.highlight {
          background-color: unset;
          color: white;
        }

        div#clues {
          background: dimgrey;
          width: 100%;
          max-width: unset;
          height: 40px;
          margin-top: 0px;
          position: fixed;

          ul {
            margin: 10px;
            padding-left: 10px;
          }
        }

        .body > div {
          margin-top: 40px;
          max-width: unset;
        }

        body {
          margin: 0;
          background: grey;
          color: white;
        }

        a {
          color: lightblue;
        }

        #clues h3,
        li:not(.highlight) {
          display: none;
        }

        div#crossword-container {
          width: auto;
        }

        div#csv-inputs {
          background: dimgrey;
        }

        .cell {
          width: auto;

          input {
            font-size: min(5vw, 20px);
          }
        }

        div#loaded-message {
          padding: 10px;
        }

        #newGame {
          margin-left: 10px;
        }
        .footer {
          padding: 10px;
          background: dimgrey;
        }

        .cluenum {
          left: 0.5vw;
          font-size: 2vw;
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <div class="body">
      <div>
        <div id="crossword-container" class="hidden">
          Add a CSV and click "Start Crossword"
        </div>
        <button id="newGame" class="hidden">ðŸ”„ New Game</button>
        <div id="loaded-message" class="hidden">
          CSV Loaded
          <button id="toggle-csv-inputs">Change CSV</button>
        </div>
        <div id="csv-inputs">
          <button id="tryBtn">â–¶ Try it out</button><br />
          <hr />
          <label>Make a column of clues and a column of answers</label><br />
          <img src="example-crossword-csv-screenshot.png" /><br />
          <label>Load your CSV from a URL:</label><br />
          <input type="text" id="csvUrl" style="width: 300px" />
          <p class="example">
            e.g.
            https://docs.google.com/spreadsheets/d/abc123/export?format=csv&gid=123
          </p>
          <label>-OR- Load your CSV from a file:</label><br />
          <input type="file" id="csvFile" accept=".csv" /><br /><br />
          <input type="checkbox" id="swapClues" value="false" />
          <label for="swapClues">Randomly swap clues and answers?</label><br />
          <button id="startBtn">â–¶ Start Crossword</button>
        </div>
      </div>
      <div id="clues"></div>
    </div>
    <div class="footer">
      Made by Ben Fullalove using ChatGPT and
      <a href="https://github.com/MichaelWehar/Crossword-Layout-Generator"
        >MichaelWehar/Crossword-Layout-Generator</a
      >
    </div>

    <script src="layout_generator.js"></script>
    <script>
      let cells = [],
        entries = [],
        selectedEntry = null;
      let CSV_URL = localStorage.getItem("csvUrl") || "";
      let CSV_TEXT = localStorage.getItem("csvText") || "";
      let SWAP_CLUES = localStorage.getItem("swapClues") ?? false;
      document.getElementById("csvUrl").value = CSV_URL;
      document.getElementById("swapClues").checked = SWAP_CLUES;

      document.getElementById("csvFile").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            CSV_TEXT = event.target.result;
            localStorage.setItem("csvText", CSV_TEXT);
            localStorage.removeItem("csvUrl");
            document.getElementById("csvUrl").value = "";
          };
          reader.readAsText(file);
        }
      });

      document
        .getElementById("startBtn")
        .addEventListener("click", async () => {
          const url = document.getElementById("csvUrl").value.trim();
          if (url) {
            localStorage.setItem("csvUrl", url);
            localStorage.removeItem("csvText");
            CSV_URL = url;
            CSV_TEXT = "";
          }
          localStorage.setItem("swapClues", SWAP_CLUES);
          startGame();
        });

      document
        .getElementById("swapClues")
        .addEventListener("change", async (e) => {
          SWAP_CLUES = e.target.checked;
        });

      document.getElementById("tryBtn").addEventListener("click", async () => {
        CSV_URL =
          "https://docs.google.com/spreadsheets/d/1osHofMaYvKOr1dlYyfFlXz7JadkH5WEGwnx2SrxGDVU/export?format=csv&gid=328967725";
        CSV_TEXT = "";
        SWAP_CLUES = false;

        startGame();
      });

      document
        .getElementById("newGame")
        .addEventListener("click", () => location.reload());
      document
        .getElementById("toggle-csv-inputs")
        .addEventListener("click", () => {
          document.getElementById("csv-inputs").classList.toggle("hidden");
        });

      async function fetchWordPairsFromUrl(url) {
        const res = await fetch(url);
        const text = await res.text();
        return parseCSV(text);
      }

      function parseCSV(text) {
        const rows = text.trim().split("\n").slice(1);
        return rows
          .map((r) => {
            const [en, tl] = r
              .split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
              .map((s) => s.replace(/^"(.*)"$/, "$1").trim());
            return { en, tl };
          })
          .filter((p) => p.en && p.tl);
      }

      function preparePuzzle(pairs, count = 10) {
        pairs = pairs.sort(() => Math.random() - 0.5);
        const chosen = pairs.slice(0, count);
        return chosen.map(({ en, tl }) => {
          return SWAP_CLUES && Math.random() < 0.5
            ? { clue: tl, answer: en.toUpperCase() }
            : { clue: en, answer: tl.toUpperCase() };
        });
      }

      function renderGrid(rows, cols, entries) {
        const container = document.getElementById("crossword-container");
        container.innerHTML = "";
        const table = document.createElement("div");
        table.className = "table";
        cells = Array.from({ length: rows }, () => Array(cols).fill(null));

        for (let r = 0; r < rows; r++) {
          const row = document.createElement("div");
          row.className = "row";
          for (let c = 0; c < cols; c++) {
            const cell = document.createElement("div");
            cell.className = "cell";
            cell.dataset.r = r;
            cell.dataset.c = c;
            cells[r][c] = cell;
            row.appendChild(cell);
          }
          table.appendChild(row);
        }

        entries.forEach((entry) => {
          const { startx, starty, position, orientation, answer } = entry;
          const dx = orientation === "across" ? 1 : 0;
          const dy = orientation === "down" ? 1 : 0;

          for (let i = 0; i < answer.length; i++) {
            const r = starty - 1 + dy * i;
            const c = startx - 1 + dx * i;
            const cell = cells[r][c];
            cell.classList.add("editable");
            const input = document.createElement("input");
            input.autocomplete = "off";
            cell.querySelector("input")?.remove();
            cell.appendChild(input);
            cell.dataset.entries =
              (cell.dataset.entries || "") + `${position}-${orientation},`;
          }

          const r0 = starty - 1,
            c0 = startx - 1;
          const div = document.createElement("div");
          div.className = "cluenum";
          div.textContent = position;
          cells[r0][c0].appendChild(div);
        });

        container.appendChild(table);
      }

      function renderClues(entries) {
        const container = document.getElementById("clues");
        const across = entries.filter((e) => e.orientation === "across");
        const down = entries.filter((e) => e.orientation === "down");
        container.innerHTML = `
        <h3>Across</h3><ul>${across
          .map(
            (e) => `
          <li data-pos="${e.position}" data-orient="across">
            ${e.position}. ${e.clue}
            <button class="reveal-letter" data-pos="${e.position}" data-orient="across">Reveal Letter</button>
          </li>`
          )
          .join("")}</ul>
        <h3>Down</h3><ul>${down
          .map(
            (e) => `
          <li data-pos="${e.position}" data-orient="down">
            ${e.position}. ${e.clue}
            <button class="reveal-letter" data-pos="${e.position}" data-orient="down">Reveal Letter</button>
          </li>`
          )
          .join("")}</ul>
      `;

        document.querySelectorAll(".reveal-letter").forEach((button) => {
          button.addEventListener("click", () => {
            if (confirm("Reveal the selected letter?")) {
              const focusedCell = document.querySelector(".cell.focus");
              if (!focusedCell) {
                alert("No letter is currently focused.");
                return;
              }
              const pos = button.dataset.pos;
              const orient = button.dataset.orient;
              const entry = entries.find(
                (e) => e.position == pos && e.orientation === orient
              );
              if (!entry) return;

              const entryCells = getEntryCells(entry);
              const index = entryCells.indexOf(focusedCell);
              if (index === -1) {
                alert("Focused letter is not part of this clue.");
                return;
              }
              const cell = entryCells[index];
              const input = cell.querySelector("input");
              if (!input.classList.contains("revealed")) {
                input.value = entry.answer[index];
                cell.classList.add("revealed");
                cell.classList.add("filled");
                cell.classList.remove("active");
                input.blur();
              }
              moveNext(cell);
              checkAllEntries();
            }
          });
        });
      }

      function getEntryCells(entry) {
        const dx = entry.orientation === "across" ? 1 : 0;
        const dy = entry.orientation === "down" ? 1 : 0;
        return Array.from({ length: entry.answer.length }, (_, i) => {
          const r = entry.starty - 1 + dy * i;
          const c = entry.startx - 1 + dx * i;
          return cells[r][c];
        });
      }

      function highlightEntry(entry) {
        document
          .querySelectorAll(".cell")
          .forEach((cell) => cell.classList.remove("highlight", "active"));
        document
          .querySelectorAll("#clues li")
          .forEach((li) => li.classList.remove("highlight"));
        getEntryCells(entry).forEach((cell) => cell.classList.add("highlight"));
        const li = document.querySelector(
          `#clues li[data-pos='${entry.position}'][data-orient='${entry.orientation}']`
        );
        if (li) li.classList.add("highlight");
      }

      function enableInputHandlers() {
        cells.flat().forEach((cell) => {
          if (!cell.classList.contains("editable")) return;

          cell.addEventListener("click", (e) => {
            e.stopPropagation();
            const options = (cell.dataset.entries || "")
              .split(",")
              .filter(Boolean)
              .map((id) => {
                const [pos, orient] = id.split("-");
                return entries.find(
                  (e) => e.position == pos && e.orientation === orient
                );
              });
            if (selectedEntry && options.includes(selectedEntry)) {
              const alt = options.find((e) => e !== selectedEntry);
              selectedEntry = alt || selectedEntry;
            } else {
              selectedEntry =
                options.find((e) => e.orientation === "across") || options[0];
            }
            if (cell.classList.contains("filled")) {
              document.querySelector(".cell.focus").classList.remove("focus");
            }
            highlightEntry(selectedEntry);
          });

          const input = cell.querySelector("input");
          input.addEventListener("input", (e) => {
            input.value = input.value.slice(-1).toUpperCase();
            moveNext(cell);
            checkAllEntries();
          });

          input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace") {
              if (input.value) {
                input.value = "";
              } else {
                e.preventDefault();
                movePrev(cell);
              }
            }
          });

          input.addEventListener("focus", (e) => {
            document
              .querySelectorAll(".cell")
              .forEach((c) => c.classList.remove("focus"));
            cell.classList.add("focus");
          });
        });
      }

      function moveNext(currentTd) {
        if (!selectedEntry) return;
        const cellsInEntry = getEntryCells(selectedEntry);
        const index = cellsInEntry.indexOf(currentTd);
        for (let i = index + 1; i < cellsInEntry.length; i++) {
          if (!cellsInEntry[i].classList.contains("filled")) {
            cellsInEntry[i].querySelector("input").focus();
            return;
          }
        }
      }

      function movePrev(currentTd) {
        if (!selectedEntry) return;
        const cellsInEntry = getEntryCells(selectedEntry);
        const index = cellsInEntry.indexOf(currentTd);
        for (let i = index - 1; i >= 0; i--) {
          if (!cellsInEntry[i].classList.contains("filled")) {
            cellsInEntry[i].querySelector("input").value = "";
            cellsInEntry[i].querySelector("input").focus();
            return;
          }
        }
      }

      function checkAllEntries() {
        let allDone = true;
        entries.forEach((entry) => {
          const word = getEntryCells(entry)
            .map((cell) => {
              const val = cell.querySelector("input").value;
              return val ? val.toUpperCase() : " ";
            })
            .join("");

          if (word === entry.answer) {
            getEntryCells(entry).forEach((cell) => {
              cell.classList.add("filled");
              cell.classList.remove("active");
              cell.querySelector("input").blur();
            });
            const li = document.querySelector(
              `li[data-pos="${entry.position}"][data-orient="${entry.orientation}"]`
            );
            if (li) li.classList.add("strike");
          } else {
            allDone = false;
          }
        });

        if (allDone) {
          setTimeout(() => {
            alert("You win!");
            document.getElementById("newGame").classList.remove("hidden");
          }, 100);
        }
      }

      async function startGame() {
        const loader = document.createElement("div");
        loader.id = "loader";
        loader.textContent = "Loading...";
        document.getElementById("loaded-message").appendChild(loader);
        document.getElementById("csv-inputs").classList.add("hidden");
        let wordPairs = [];
        if (CSV_TEXT) wordPairs = parseCSV(CSV_TEXT);
        else if (CSV_URL) wordPairs = await fetchWordPairsFromUrl(CSV_URL);
        else return alert("Please provide a CSV file or URL.");

        document
          .getElementById("crossword-container")
          .classList.remove("hidden");
        document.getElementById("loaded-message").classList.remove("hidden");
        document.getElementById("loader").remove();

        const puzzleData = preparePuzzle(wordPairs, 10);
        const layout = generateLayout(puzzleData);
        entries = layout.result.filter((e) => e.orientation !== "none");

        renderGrid(layout.rows, layout.cols, entries);
        renderClues(entries);
        enableInputHandlers();
      }

      if (CSV_URL || CSV_TEXT) startGame();
    </script>
  </body>
</html>
